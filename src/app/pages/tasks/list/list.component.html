<div class="container-fluid">

  <!-- start page title -->
  <app-page-title title="Task List" [breadcrumbItems]="breadCrumbItems"></app-page-title>
  <!-- end page title -->

  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start">
            <h4 class="card-title mb-4">Upcoming</h4>
          </div>
          <ng-template #content role="document" let-modal>
            <div class="modal-header">
              <h5 class="modal-title mt-0">Add Customer</h5>
              <button type="button" class="btn-close" aria-hidden="true" (click)="modalRef?.hide()"></button>
            </div>
            <div class="modal-body">
              <form (ngSubmit)="listData()" [formGroup]="formData">
                <div class="row">
                  <div class="col-12">
                    <div class="mb-3">
                      <label for="tasktype">Task Type</label>
                      <select class="form-select" formControlName="taskType">
                        <option value="inprogress">Inprogress</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="completed">Completed</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="control-label">Task title</label>
                      <input class="form-control" placeholder="Enter title" type="text" name="title" formControlName="name" [ngClass]="{'is-invalid': submitted && form.name.errors}" />
                      @if(submitted && form.name.errors){
                      <div class="invalid-feedback">
                        @if(form.name.errors.required){
                        <span>Name is required.</span>
                        }
                      </div>
                      }
                    </div>
                    <div class="mb-3">
                      <label for="file">File</label>
                      <input formControlName="file" id="file" type="file" multiple class="form-control" (change)="onFileChange($event)">
                      @if(submitted && form.file.touched && submitted && form.file.invalid){
                      <div class="alert alert-danger">
                        @if(submitted && form.file.errors.required){
                        <div>File is required.</div>
                        }
                      </div>}
                    </div>
                    <div class="mb-3">
                      <label for="status">Task Status</label>
                      <select class="form-select" formControlName="status">
                        <option value="Pending">Pending</option>
                        <option value="Waiting">Waiting</option>
                        <option value="Complete">Complete</option>
                        <option value="Approved">Approved</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button class="btn btn-success">Submit</button>
              </form>
            </div>

          </ng-template>
          <div class="table-responsive">
            <table class="table table-nowrap align-middle mb-0">
              <tbody>
                @for(list of upcomingTasks;track $index){
                <tr>
                  <td style="width: 40px;">
                    <div class="form-check font-size-16">
                      <input type="checkbox" class="form-check-input" id="customCheck{{list.index}}" 
                             [(ngModel)]="list.checked" (change)="toggleTaskCompletion(list)">
                      <label class="form-check-label" for="customCheck{{list.index}}"></label>
                    </div>
                  </td>
                  <td>
                    <h5 class="text-truncate font-size-14 m-0"><a href="javascript: void(0);" class="text-dark">{{list.name}}</a></h5>
                  </td>
                  <td>
                    <div class="avatar-group">
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{list.images[0]}}" class="rounded-circle avatar-xs" alt="">
                        </a>
                      </div>
                      @if(list.images[1]){
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{list.images[1]}}" class="rounded-circle avatar-xs" alt="">
                        </a>
                      </div>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="text-center">
                      <span class="badge rounded-pill font-size-11" [ngClass]="{'badge-soft-primary': list.status  === 'Approved',
                      'badge-soft-secondary': list.status === 'Waiting'}">{{list.status}}</span>
                    </div>
                  </td>
                </tr>}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start">
            <h4 class="card-title mb-4">In Progress</h4>
          </div>
          <div class="table-responsive">
            <table class="table table-nowrap align-middle mb-0">
              <tbody>
                @for(progresstask of inprogressTasks;track $index){
                <tr>
                  <td style="width: 40px;">
                    <div class="form-check font-size-16">
                      <input type="checkbox" class="form-check-input" id="customCheck{{progresstask.index}}" 
                             [(ngModel)]="progresstask.checked" (change)="toggleTaskCompletion(progresstask)">
                      <label class="form-check-label" for="customCheck{{progresstask.index}}"></label>
                    </div>
                  </td>
                  <td>
                    <h5 class="text-truncate font-size-14 m-0"><a href="javascript: void(0);" class="text-dark">{{progresstask.name}}</a></h5>
                  </td>
                  <td>
                    <div class="avatar-group">
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{progresstask.images[0]}}" class="rounded-circle avatar-xs" alt="">
                        </a>
                      </div>
                      @if(progresstask.images[1]){
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{progresstask.images[1]}}" class="rounded-circle avatar-xs" alt="">
                        </a>
                      </div>}
                    </div>
                  </td>
                  <td>
                    <div class="text-center">
                      <span class="badge rounded-pill badge-soft-success font-size-11" [ngClass]="{'badge-soft-warning': progresstask.status  === 'Pending'}">{{progresstask.status}}</span>
                    </div>
                  </td>
                </tr>}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start">
            <h4 class="card-title mb-4">Completed</h4>
          </div>
          <div class="table-responsive">
            <table class="table table-nowrap align-middle mb-0">
              <tbody>
                @for(completetask of completedTasks;track $index){
                <tr>
                  <td style="width: 40px;">
                    <div class="form-check font-size-16">
                      <input type="checkbox" class="form-check-input" id="customCheck{{completetask.index}}" 
                             [(ngModel)]="completetask.checked" (change)="toggleTaskCompletion(completetask)">
                      <label class="form-check-label" for="customCheck{{completetask.index}}"></label>
                    </div>
                  </td>
                  <td>
                    <h5 class="text-truncate font-size-14 m-0"><a href="javascript: void(0);" class="text-dark">{{completetask.name}}</a>
                    </h5>
                  </td>
                  <td>
                    <div class="avatar-group">
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{completetask.images[0]}}" class="rounded-circle avatar-xs m-1" alt="">
                        </a>
                      </div>
                      @if(completetask.images[1]){
                      <div class="avatar-group-item">
                        <a href="javascript: void(0);" class="d-inline-block">
                          <img src="{{completetask.images[1]}}" class="rounded-circle avatar-xs m-1" alt="">
                        </a>
                      </div>}
                    </div>
                  </td>
                  <td>
                    <div class="text-center">
                      <span class="badge rounded-pill badge-soft-success font-size-11">{{completetask.status}}</span>
                    </div>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- end col -->

    <div class="col-lg-4">
      <!-- Task Statistics Cards -->
      <div class="row">
        <div class="col-md-6">
          <div class="card mini-stats-wid">
            <div class="card-body">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <p class="text-muted fw-medium">Total Tasks</p>
                  <h4 class="mb-0">{{ taskStats.total }}</h4>
                </div>
                <div class="flex-shrink-0 align-self-center">
                  <div class="mini-stat-icon avatar-sm rounded-circle bg-primary">
                    <span class="avatar-title">
                      <i class="bx bx-task font-size-24"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mini-stats-wid">
            <div class="card-body">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <p class="text-muted fw-medium">Completed</p>
                  <h4 class="mb-0">{{ taskStats.completed }}</h4>
                </div>
                <div class="flex-shrink-0 align-self-center">
                  <div class="mini-stat-icon avatar-sm rounded-circle bg-success">
                    <span class="avatar-title">
                      <i class="bx bx-check-circle font-size-24"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <div class="card mini-stats-wid">
            <div class="card-body">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <p class="text-muted fw-medium">In Progress</p>
                  <h4 class="mb-0">{{ taskStats.inProgress }}</h4>
                </div>
                <div class="flex-shrink-0 align-self-center">
                  <div class="mini-stat-icon avatar-sm rounded-circle bg-warning">
                    <span class="avatar-title">
                      <i class="bx bx-time-five font-size-24"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card mini-stats-wid">
            <div class="card-body">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <p class="text-muted fw-medium">Upcoming</p>
                  <h4 class="mb-0">{{ taskStats.upcoming }}</h4>
                </div>
                <div class="flex-shrink-0 align-self-center">
                  <div class="mini-stat-icon avatar-sm rounded-circle bg-info">
                    <span class="avatar-title">
                      <i class="bx bx-hourglass font-size-24"></i>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h4 class="card-title mb-3">Tasks Overview</h4>

          <apx-chart dir="ltr" class="apex-charts" [series]="taskChart.series" [chart]="taskChart.chart" [yaxis]="taskChart.yaxis" [stroke]="taskChart.stroke" [colors]="taskChart.colors" [fill]="taskChart.fill" [plotOptions]="taskChart.plotOptions" [markers]="taskChart.markers" [labels]="taskChart.labels">
          </apx-chart>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h4 class="card-title mb-4">Recent Tasks</h4>

          <div class="table-responsive">
            <table class="table table-nowrap align-middle mb-0">
              <tbody>
                @if(allTasks.length > 0) {
                  @for(projectData of allTasks.slice(0, 3); track projectData.project?.id) {
                    @if(projectData.taskLists && projectData.taskLists.length > 0) {
                      @for(taskList of projectData.taskLists.slice(0, 2); track taskList.parent?.id) {
                        @if(taskList.parent) {
                          <tr>
                            <td>
                              <h5 class="text-truncate font-size-14 m-0">
                                <a href="javascript: void(0);" class="text-dark">{{ taskList.parent.title || 'Untitled Task' }}</a>
                              </h5>
                              <p class="text-muted mb-0 font-size-12">
                                <i class="bx bx-folder-open"></i> {{ projectData.project?.name }}
                                <span class="badge badge-soft-{{ taskList.parent.is_completed ? 'success' : 'warning' }} ms-2">
                                  {{ taskList.parent.is_completed ? 'Complete' : 'In Progress' }}
                                </span>
                              </p>
                            </td>
                            <td>
                              <div class="avatar-group">
                                <div class="avatar-group-item">
                                  <a href="javascript: void(0);" class="d-inline-block">
                                    <img src="assets/images/users/avatar-1.jpg" alt="" class="rounded-circle avatar-xs">
                                  </a>
                                </div>
                              </div>
                            </td>
                          </tr>
                        }
                        @if(taskList.subTasks && taskList.subTasks.length > 0) {
                          <tr>
                            <td>
                              <h5 class="text-truncate font-size-14 m-0">
                                <a href="javascript: void(0);" class="text-dark">{{ taskList.subTasks[0].description || taskList.subTasks[0].title || 'Untitled Subtask' }}</a>
                              </h5>
                              <p class="text-muted mb-0 font-size-12">
                                <i class="bx bx-subdirectory-right"></i> Subtask
                                <span class="badge badge-soft-{{ taskList.subTasks[0].is_completed ? 'success' : 'info' }} ms-2">
                                  {{ taskList.subTasks[0].is_completed ? 'Complete' : 'Pending' }}
                                </span>
                              </p>
                            </td>
                            <td>
                              <div class="avatar-group">
                                <div class="avatar-group-item">
                                  <a href="javascript: void(0);" class="d-inline-block">
                                    <img src="assets/images/users/avatar-2.jpg" alt="" class="rounded-circle avatar-xs">
                                  </a>
                                </div>
                              </div>
                            </td>
                          </tr>
                        }
                      }
                    }
                  }
                } @else {
                  <tr>
                    <td colspan="2" class="text-center text-muted">
                      <p class="mb-0">No tasks available</p>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <!-- end table responsive -->
        </div>
      </div>

    </div>
  </div>
  <!-- end row -->

</div> <!-- container-fluid -->