<div class="container-fluid">
  <app-page-title title="Inbox" [breadcrumbItems]="breadCrumbItems"></app-page-title>
  <div class="row">
    <div class="col-12">
      <div class="email-leftbar card">
        <div class="d-flex gap-2 mb-3">
          <button type="button" class="btn btn-danger flex-fill" data-toggle="modal" data-target="#composemodal"
            (click)="open(content)">
            Compose
          </button>
        </div>
        <div class="mail-list mt-4">
          <a href="javascript: void(0);" class="active" (click)="categoryFilter($event,'all')"><i
              class="mdi mdi-email-outline me-2"></i> Inbox <span class="ms-1 float-end">(18)</span></a>
          <a href="javascript: void(0);" (click)="categoryFilter($event,'starred')"><i
              class="mdi mdi-star-outline me-2"></i>Starred</a>
          <a href="javascript: void(0);" (click)="categoryFilter($event,'important')"><i
              class="mdi mdi-diamond-stone me-2"></i>Important</a>
          <a href="javascript: void(0);" (click)="categoryFilter($event,'draft')"><i
              class="mdi mdi-file-outline me-2"></i>Draft</a>
          <a href="javascript: void(0);" (click)="categoryFilter($event,'sent-mail')"><i
              class="mdi mdi-email-check-outline me-2"></i>Sent Mail</a>
          <a href="javascript: void(0);" (click)="categoryFilter($event,'trash')"><i
              class="mdi mdi-trash-can-outline me-2"></i>Trash</a>
        </div>

        <h6 class="mt-4">Labels</h6>

        <div class="mail-list mt-1">
          <a href="javascript: void(0);"><span class="mdi mdi-arrow-right-drop-circle text-info float-end"></span>Theme
            Support</a>
          <a href="javascript: void(0);"><span
              class="mdi mdi-arrow-right-drop-circle text-warning float-end"></span>Freelance</a>
          <a href="javascript: void(0);"><span
              class="mdi mdi-arrow-right-drop-circle text-primary float-end"></span>Social</a>
          <a href="javascript: void(0);"><span
              class="mdi mdi-arrow-right-drop-circle text-danger float-end"></span>Friends</a>
          <a href="javascript: void(0);"><span
              class="mdi mdi-arrow-right-drop-circle text-success float-end"></span>Family</a>
        </div>

        <h6 class="mt-4">Chat</h6>

        <div class="mt-2">
          <a href="javascript: void(0);" class="d-flex">
            <div class="flex-shrink-0 me-3">
              <img class="rounded-circle" src="assets/images/users/avatar-2.jpg" alt="Generic placeholder image"
                height="36">
            </div>
            <div class="flex-grow-1 chat-user-box">
              <p class="user-title m-0">Scott Median</p>
              <p class="text-muted">Hello</p>
            </div>
          </a>

          <a href="javascript: void(0);" class="d-flex">
            <div class="flex-shrink-0 me-3">
              <img class="rounded-circle" src="assets/images/users/avatar-3.jpg" alt="Generic placeholder image"
                height="36">
            </div>
            <div class="flex-grow-1 chat-user-box">
              <p class="user-title m-0">Julian Rosa</p>
              <p class="text-muted">What about our next..</p>
            </div>
          </a>

          <a href="javascript: void(0);" class="d-flex">
            <div class="flex-shrink-0 me-3">
              <img class="rounded-circle" src="assets/images/users/avatar-4.jpg" alt="Generic placeholder image"
                height="36">
            </div>
            <div class="flex-grow-1 chat-user-box">
              <p class="user-title m-0">David Medina</p>
              <p class="text-muted">Yeah everything is fine</p>
            </div>
          </a>

          <a href="javascript: void(0);" class="d-flex">
            <div class="flex-shrink-0 me-3">
              <img class="rounded-circle" src="assets/images/users/avatar-6.jpg" alt="Generic placeholder image"
                height="36">
            </div>
            <div class="flex-grow-1 chat-user-box">
              <p class="user-title m-0">Jay Baker</p>
              <p class="text-muted">Wow that's great</p>
            </div>
          </a>
        </div>
        <ng-template #content let-modal>
          <div class="modal-header">
            <h5 class="modal-title" id="composemodalTitle">New Message</h5>
            <button type="button" class="btn-close" (click)="modalRef?.hide()" aria-label="Close">

            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <input type="email" class="form-control" placeholder="To">
              </div>
              <div class="mb-3">
                <input type="text" class="form-control" placeholder="Subject">
              </div>
              <div class="mb-3">
                <!-- <ckeditor [editor]="Editor" data="<p>Content of the editor.</p>"></ckeditor> -->
                <ngx-editor-menu [editor]="editor"> </ngx-editor-menu>
                <ngx-editor [editor]="editor" [ngModel]="html" [disabled]="false"
                  [placeholder]="'Type here...'"></ngx-editor>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="modalRef?.hide()">Close</button>
            <button type="button" class="btn btn-primary">Send <i class="fab fa-telegram-plane ms-1"></i></button>
          </div>
        </ng-template>

      </div>

      <div class="email-rightbar mb-3">

        <!-- Gmail Connection Status Card -->
        <div class="card mb-3" *ngIf="!isGmailConnected">
          <div class="card-body text-center py-5">
            <div *ngIf="isCheckingStatus" class="mb-4">
              <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Checking connection...</span>
              </div>
              <p class="mt-2 text-muted">Checking Gmail connection...</p>
            </div>
            
            <div *ngIf="!isCheckingStatus && !isGmailConnected && !showLoginForm" class="gmail-connect-section">
              <i class="ri-mail-line font-size-48 text-muted mb-3 d-block"></i>
              <h4 class="mb-3">Connect Your Gmail Account</h4>
              <p class="text-muted mb-4">
                Connect your Gmail account to manage emails directly from the accountant portal. 
                You'll be able to view, send, and organize your emails seamlessly.
              </p>
              
              <button 
                type="button" 
                class="btn btn-primary btn-lg"
                (click)="showGmailLogin()">
                <i class="ri-mail-line me-2"></i>
                Connect Gmail Account
              </button>
              
              <div class="mt-3">
                <small class="text-muted">
                  <i class="ri-shield-check-line me-1"></i>
                  Your data is secure and we only access what you authorize
                </small>
              </div>
            </div>

            <!-- Gmail Login Form -->
            <div *ngIf="!isCheckingStatus && !isGmailConnected && showLoginForm" class="gmail-login-section">
              <i class="ri-mail-line font-size-48 text-primary mb-3 d-block"></i>
              <h4 class="mb-3">Gmail Login</h4>
              <p class="text-muted mb-4">
                Enter your Gmail credentials to connect your account
              </p>
              
              <form [formGroup]="gmailLoginForm" (ngSubmit)="loginGmail()" class="text-start">
                <div class="mb-3">
                  <label for="gmailEmail" class="form-label">Gmail Address</label>
                  <input 
                    type="email" 
                    class="form-control"
                    [class.is-invalid]="hasFieldError('email')"
                    id="gmailEmail" 
                    formControlName="email"
                    placeholder="Enter your Gmail address"
                    [disabled]="isLoadingGmail">
                  <div class="invalid-feedback" *ngIf="hasFieldError('email')">
                    {{ getFieldError('email') }}
                  </div>
                </div>
                
                <div class="mb-4">
                  <label for="gmailPassword" class="form-label">Password</label>
                  <input 
                    type="password" 
                    class="form-control"
                    [class.is-invalid]="hasFieldError('password')"
                    id="gmailPassword" 
                    formControlName="password"
                    placeholder="Enter your Gmail password"
                    [disabled]="isLoadingGmail">
                  <div class="invalid-feedback" *ngIf="hasFieldError('password')">
                    {{ getFieldError('password') }}
                  </div>
                </div>
                
                <div class="d-flex gap-2 justify-content-center">
                  <button 
                    type="button" 
                    class="btn btn-secondary"
                    (click)="hideGmailLogin()"
                    [disabled]="isLoadingGmail">
                    Cancel
                  </button>
                  
                  <button 
                    type="submit" 
                    class="btn btn-primary"
                    [disabled]="isLoadingGmail || gmailLoginForm.invalid">
                    <span *ngIf="isLoadingGmail" class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <i *ngIf="!isLoadingGmail" class="ri-login-circle-line me-2"></i>
                    {{ isLoadingGmail ? 'Connecting...' : 'Connect' }}
                  </button>
                </div>
              </form>
              
              <div class="mt-3">
                <small class="text-muted">
                  <i class="ri-information-line me-1"></i>
                  We recommend using an App Password instead of your main password for better security
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Gmail Connected Status -->
        <div class="alert alert-success d-flex align-items-center mb-3" *ngIf="isGmailConnected">
          <i class="ri-checkbox-circle-line me-2"></i>
          <div class="flex-grow-1">
            <strong>Gmail Connected:</strong> {{ gmailEmail }}
          </div>
          <button type="button" class="btn btn-sm btn-outline-danger" (click)="disconnectGmail()">
            <i class="ri-logout-circle-line me-1"></i>Disconnect
          </button>
        </div>

        <div class="card">
          <div class="btn-toolbar p-3" role="toolbar">
            <div class="btn-group me-2 mb-2 mb-sm-0">
              <button type="button" class="btn btn-primary"><i class="fa fa-inbox"></i></button>
              <button type="button" class="btn btn-primary"><i class="fa fa-exclamation-circle"></i></button>
              <button type="button" (click)="confirm()" class="btn btn-primary"><i
                  class="far fa-trash-alt"></i></button>
            </div>
            <div class="btn-group me-2 mb-2 mb-sm-0" dropdown>
              <button type="button" class="btn btn-primary dropdown-toggle" dropdownToggle data-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-folder"></i> <i class="mdi mdi-chevron-down ms-1"></i>
              </button>
              <div class="dropdown-menu" *dropdownMenu>
                <a class="dropdown-item" href="javascript: void(0);">Updates</a>
                <a class="dropdown-item" href="javascript: void(0);">Social</a>
                <a class="dropdown-item" href="javascript: void(0);">Team Manage</a>
              </div>
            </div>
            <div class="btn-group me-2 mb-2 mb-sm-0" dropdown>
              <button type="button" class="btn btn-primary dropdown-toggle" dropdownToggle data-toggle="dropdown"
                aria-expanded="false">
                <i class="fa fa-tag"></i> <i class="mdi mdi-chevron-down ms-1"></i>
              </button>
              <div class="dropdown-menu" *dropdownMenu>
                <a class="dropdown-item" href="javascript: void(0);">Updates</a>
                <a class="dropdown-item" href="javascript: void(0);">Social</a>
                <a class="dropdown-item" href="javascript: void(0);">Team Manage</a>
              </div>
            </div>

            <div class="btn-group me-2 mb-2 mb-sm-0" dropdown>
              <button type="button" class="btn btn-primary dropdown-toggle" dropdownToggle data-toggle="dropdown"
                aria-expanded="false">
                More<i class="mdi mdi-dots-vertical ms-2"></i>
              </button>
              <div class="dropdown-menu" *dropdownMenu>
                <a class="dropdown-item" (click)="markUnread()" href="javascript: void(0);">Mark as Unread</a>
                <a class="dropdown-item" href="javascript: void(0);">Mark as Important</a>
                <a class="dropdown-item" href="javascript: void(0);">Add to Tasks</a>
                <a class="dropdown-item" href="javascript: void(0);">Add Star</a>
                <a class="dropdown-item" href="javascript: void(0);">Mute</a>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoadingGmail" class="text-center py-5">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="sr-only">Loading emails...</span>
            </div>
            <p class="text-muted">Loading Gmail messages...</p>
          </div>

          <!-- Message List -->
          <ul class="message-list" *ngIf="!isLoadingGmail">
            @for(email of emailData | slice:0:15;track $index){
            <li class="unread" [ngClass]="{ 'unread': email.unread === true }">
              <div class="col-mail col-mail-1">
                <div class="checkbox-wrapper-mail">
                  <input type="checkbox" id="chk-{{$index}}" (change)="selectMail($event,email.id)" />
                  <label for="chk-{{$index}}"></label>
                </div>
                <a [routerLink]="['../read',email.id]" class="title">{{email.title}}</a>
                <span class="star-toggle far fa-star" [ngClass]="{'fas': email.isIcon == true}"></span>
              </div>
              <div class="col-mail col-mail-2">
                <a [routerLink]="['../read',email.id]" class="subject">{{email.subject}}</a>
                <div class="date">{{email.date}}</div>
              </div>
            </li>}
            
            <!-- No Messages State -->
            @if(emailData.length === 0) {
            <li class="text-center py-4">
              <div class="text-muted">
                <i class="ri-mail-line font-size-48 mb-3 d-block"></i>
                <h5>No messages found</h5>
                <p>{{ isGmailConnected ? 'Your Gmail inbox is empty' : 'Connect Gmail to view your messages' }}</p>
              </div>
            </li>
            }
          </ul>
        </div>
        <div class="row justify-content-md-between align-items-md-center">
          <div class="col-7">
            Showing {{startIndex}} - {{endIndex}} of {{totalRecords}}
          </div> <!-- end col-->
          <div class="col-5">
            <div class="btn-group float-end">
              <button type="button" class="btn btn-sm btn-success waves-effect"><i
                  class="fa fa-chevron-left"></i></button>
              <button type="button" class="btn btn-sm btn-success waves-effect"><i
                  class="fa fa-chevron-right"></i></button>
            </div>
          </div> <!-- end col-->
        </div>
      </div>
    </div>
  </div>
</div>