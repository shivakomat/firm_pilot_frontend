<div class="chat-container">
  <!-- Chat Mode Toggle -->
  <div class="chat-mode-toggle mb-3">
    <div class="btn-group w-100" role="group">
      <button type="button" 
              class="btn" 
              [class.btn-primary]="chatMode === 'accountant'"
              [class.btn-outline-primary]="chatMode !== 'accountant'"
              (click)="switchChatMode('accountant')">
        <i class="ri-user-3-line me-2"></i>Chat with Accountant
      </button>
      <button type="button" 
              class="btn" 
              [class.btn-success]="chatMode === 'ai'"
              [class.btn-outline-success]="chatMode !== 'ai'"
              (click)="switchChatMode('ai')">
        <i class="ri-robot-2-line me-2"></i>AI Tax Assistant
      </button>
    </div>
  </div>

  <!-- Chat Header -->
  <div class="chat-header">
    <div class="d-flex align-items-center">
      <div class="avatar-container me-3">
        <div class="avatar-circle" 
             [class.bg-primary]="chatMode === 'accountant'"
             [class.bg-gradient-ai]="chatMode === 'ai'">
          <i class="ri-user-line text-white" *ngIf="chatMode === 'accountant'"></i>
          <i class="ri-robot-2-line text-white" *ngIf="chatMode === 'ai'"></i>
        </div>
        <div class="status-indicator" [class.active]="chatMode === 'accountant'"></div>
      </div>
      <div>
        <h5 class="mb-0 chat-title">
          <span *ngIf="chatMode === 'accountant'">Sarah Johnson, CPA</span>
          <span *ngIf="chatMode === 'ai'">AI Tax Assistant</span>
        </h5>
        <small class="text-muted">
          <span *ngIf="chatMode === 'accountant'">Active now</span>
          <span *ngIf="chatMode === 'ai'">Always available</span>
        </small>
      </div>
    </div>
    <div class="chat-actions" *ngIf="chatMode === 'ai'">
      <button class="btn btn-light btn-sm me-2" (click)="showConversations()">
        <i class="ri-chat-history-line"></i>
      </button>
      <button class="btn btn-light btn-sm me-2" (click)="startNewConversation()">
        <i class="ri-add-line"></i>
      </button>
      <button class="btn btn-light btn-sm">
        <i class="ri-more-2-line"></i>
      </button>
    </div>
    <div class="chat-actions" *ngIf="chatMode === 'accountant'">
      <button class="btn btn-light btn-sm me-2">
        <i class="ri-search-line"></i>
      </button>
      <button class="btn btn-light btn-sm me-2">
        <i class="ri-settings-3-line"></i>
      </button>
      <button class="btn btn-light btn-sm">
        <i class="ri-more-2-line"></i>
      </button>
    </div>
  </div>
  
  <!-- Messages Area -->
  <div class="chat-messages" #messagesContainer>
    <!-- Date Separator -->
    <div class="date-separator">
      <span class="date-label">Today</span>
    </div>
    
    <ng-container *ngFor="let message of (chatMode === 'ai' ? aiMessages : messages); let i = index; trackBy: trackByMessage">
      <div class="message-container" *ngIf="message">
      <!-- Date Separator -->
      <div *ngIf="shouldShowDateSeparator(i)" class="date-separator">
        <span class="date-label">{{message?.timestamp ? formatDate(message.timestamp) : 'Today'}}</span>
      </div>
      
      <!-- Message Bubble -->
      <div class="message-row" 
           [class.message-sent]="isUserMessage(message)"
           [class.message-received]="!isUserMessage(message)">
        
        <!-- Avatar for received messages (AI/Accountant) -->
        <div *ngIf="!isUserMessage(message)" class="message-avatar">
          <div class="avatar-circle" 
               [class.bg-primary]="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'" 
               [class.bg-gradient-ai]="chatMode === 'ai' || isAIMessage(message)">
            <i class="ri-user-3-line text-white" *ngIf="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'"></i>
            <i class="ri-robot-2-line text-white" *ngIf="chatMode === 'ai' || isAIMessage(message)"></i>
          </div>
        </div>
        
        <!-- Message Bubble -->
        <div class="message-bubble" 
             [class.bubble-sent]="isUserMessage(message)"
             [class.bubble-received]="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'"
             [class.bubble-ai]="chatMode === 'ai' || isAIMessage(message)">
          
          <!-- Sender name for received messages -->
          <div class="message-sender" *ngIf="!isUserMessage(message)">
            <span *ngIf="chatMode === 'accountant'">{{message.senderName}}</span>
            <span *ngIf="chatMode === 'ai' || isAIMessage(message)">AI Tax Assistant</span>
          </div>
          
          <div class="message-text" [innerHTML]="formatMessageContent(message)"></div>
          <div class="message-time">{{message?.timestamp ? formatTime(message.timestamp) : 'Now'}}</div>
        </div>
        
        <!-- Message options for received messages -->
        <div class="message-options" *ngIf="!isUserMessage(message)">
          <button class="btn btn-sm btn-light">
            <i class="ri-more-2-fill"></i>
          </button>
        </div>
        
        <!-- Avatar for sent messages (User) -->
        <div *ngIf="isUserMessage(message)" class="message-avatar">
          <div class="avatar-circle bg-secondary">
            <i class="ri-user-line text-white"></i>
          </div>
        </div>
      </div>
      </div>
    </ng-container>
    
    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <small class="text-muted ms-2">Loading messages...</small>
    </div>
  </div>

  <!-- Message Input -->
  <div class="chat-input">
    <div class="input-container">
      <button class="btn btn-light attachment-btn">
        <i class="ri-emotion-line"></i>
      </button>
      <button class="btn btn-light attachment-btn">
        <i class="ri-attachment-2"></i>
      </button>
      <button class="btn btn-light attachment-btn">
        <i class="ri-file-line"></i>
      </button>
      <div class="input-wrapper">
        <textarea class="message-input" 
                  placeholder="Enter Message..." 
                  [(ngModel)]="newMessage" 
                  (keypress)="onKeyPress($event)"
                  [disabled]="isLoading"
                  rows="1"></textarea>
      </div>
      <button type="button" 
              class="btn send-btn" 
              (click)="sendMessage()" 
              [disabled]="!newMessage.trim() || isLoading">
        <i class="ri-send-plane-fill"></i>
      </button>
    </div>
  </div>
</div>

<!-- AI Conversations Sidebar -->
<div class="ai-conversations-sidebar" [class.show]="showConversationsList && chatMode === 'ai'">
  <div class="conversations-header">
    <h6 class="mb-0">AI Conversations</h6>
    <button class="btn btn-sm btn-light" (click)="hideConversations()">
      <i class="ri-close-line"></i>
    </button>
  </div>
  <div class="conversations-list">
    <div *ngFor="let conversation of aiConversations" 
         class="conversation-item" 
         [class.active]="currentAIConversation?.id === conversation.id"
         (click)="selectAIConversation(conversation)">
      <div class="conversation-title">{{conversation.title}}</div>
      <div class="conversation-meta">
        <small class="text-muted">{{formatDate(conversation.updatedAt)}} â€¢ {{conversation.messageCount}} messages</small>
      </div>
    </div>
    <div *ngIf="aiConversations.length === 0" class="no-conversations">
      <i class="ri-chat-3-line text-muted"></i>
      <p class="text-muted mb-0">No conversations yet</p>
    </div>
  </div>
</div>

<!-- Chat Guidelines -->
<div class="card mt-3">
  <div class="card-body">
    <h6 class="card-title">
      <span *ngIf="chatMode === 'accountant'">Chat Guidelines</span>
      <span *ngIf="chatMode === 'ai'">AI Assistant Guidelines</span>
    </h6>
    <ul class="list-unstyled mb-0" *ngIf="chatMode === 'accountant'">
      <li class="mb-2"><i class="ri-time-line text-primary me-2"></i>Response time: Usually within 2-4 hours during business hours</li>
      <li class="mb-2"><i class="ri-calendar-line text-primary me-2"></i>Business hours: Monday-Friday, 9 AM - 6 PM EST</li>
      <li class="mb-2"><i class="ri-file-line text-primary me-2"></i>For document sharing, please use the Documents section</li>
      <li><i class="ri-phone-line text-primary me-2"></i>For urgent matters, please call: (555) 123-4567</li>
    </ul>
    <ul class="list-unstyled mb-0" *ngIf="chatMode === 'ai'">
      <li class="mb-2"><i class="ri-lightbulb-line text-success me-2"></i>Ask questions about tax regulations, deductions, and filing requirements</li>
      <li class="mb-2"><i class="ri-time-line text-success me-2"></i>Get instant responses 24/7</li>
      <li class="mb-2"><i class="ri-shield-check-line text-success me-2"></i>All conversations are private and secure</li>
      <li><i class="ri-user-3-line text-success me-2"></i>For personalized advice, consult with your accountant</li>
    </ul>
  </div>
</div>
