<div class="chat-container">
  <!-- Fixed Header Section -->
  <div class="chat-header-section">
    <!-- Chat Mode Toggle -->
    <div class="chat-mode-toggle mb-3">
      <div class="btn-group w-100" role="group">
        <button type="button" 
                class="btn" 
                [class.btn-primary]="chatMode === 'accountant'"
                [class.btn-outline-primary]="chatMode !== 'accountant'"
                (click)="switchChatMode('accountant')">
          <i class="ri-user-3-line me-2"></i>Chat with Accountant
        </button>
        <button type="button" 
                class="btn" 
                [class.btn-success]="chatMode === 'ai'"
                [class.btn-outline-success]="chatMode !== 'ai'"
                (click)="switchChatMode('ai')">
          <i class="ri-robot-2-line me-2"></i>AI Tax Assistant
        </button>
      </div>
    </div>

    <!-- Chat Header -->
    <div class="chat-header">
    <div class="d-flex align-items-center">
      <div class="avatar-container me-3">
        <div class="avatar-circle" 
             [class.bg-primary]="chatMode === 'accountant'"
             [class.bg-gradient-ai]="chatMode === 'ai'">
          <i class="ri-user-line text-white" *ngIf="chatMode === 'accountant'"></i>
          <i class="ri-robot-2-line text-white" *ngIf="chatMode === 'ai'"></i>
        </div>
        <div class="status-indicator" [class.active]="chatMode === 'accountant'"></div>
      </div>
      <div>
        <h5 class="mb-0 chat-title">
          <span *ngIf="chatMode === 'accountant'">Sarah Johnson, CPA</span>
          <span *ngIf="chatMode === 'ai'">AI Tax Assistant</span>
        </h5>
        <small class="text-muted">
          <span *ngIf="chatMode === 'accountant'">Active now</span>
          <span *ngIf="chatMode === 'ai'">Always available</span>
        </small>
      </div>
    </div>
    <div class="chat-actions" *ngIf="chatMode === 'ai'">
      <button class="btn btn-light btn-sm me-2" (click)="showConversations()">
        <i class="ri-chat-history-line"></i>
      </button>
      <button class="btn btn-light btn-sm me-2" (click)="startNewConversation()">
        <i class="ri-add-line"></i>
      </button>
      <button class="btn btn-light btn-sm">
        <i class="ri-more-2-line"></i>
      </button>
    </div>
    <div class="chat-actions" *ngIf="chatMode === 'accountant'">
      <button class="btn btn-light btn-sm me-2">
        <i class="ri-search-line"></i>
      </button>
      <button class="btn btn-light btn-sm me-2">
        <i class="ri-settings-3-line"></i>
      </button>
      <button class="btn btn-light btn-sm">
        <i class="ri-more-2-line"></i>
      </button>
    </div>
  </div>
  </div>
  
  <!-- Messages Area -->
  <div class="chat-messages" #messagesContainer>
    <!-- Loading indicator during initialization -->
    <div *ngIf="!isInitialized" class="loading-container">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Initializing...</span>
      </div>
      <small class="text-muted ms-2">Loading chat...</small>
    </div>
    
    <!-- Messages content - only show when initialized -->
    <div *ngIf="isInitialized">
      <!-- Date Separator -->
      <div class="date-separator">
        <span class="date-label">Today</span>
      </div>
      
      <!-- Messages List -->
      <div *ngFor="let message of getMessagesForCurrentMode(); let i = index; trackBy: trackByMessage" class="message-container">
        <div *ngIf="message && message.content">
      <!-- Date Separator -->
      <div *ngIf="message && shouldShowDateSeparator(i)" class="date-separator">
        <span class="date-label">{{message?.timestamp ? formatDate(message.timestamp) : 'Today'}}</span>
      </div>
      
      <!-- Message Bubble -->
      <div class="message-row" 
           [class.message-sent]="isUserMessage(message)"
           [class.message-received]="!isUserMessage(message)">
        
        <!-- Avatar for received messages (AI/Accountant) -->
        <div *ngIf="!isUserMessage(message)" class="message-avatar">
          <div class="avatar-circle" 
               [class.bg-primary]="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'" 
               [class.bg-gradient-ai]="chatMode === 'ai' || isAIMessage(message)">
            <i class="ri-user-3-line text-white" *ngIf="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'"></i>
            <i class="ri-robot-2-line text-white" *ngIf="chatMode === 'ai' || isAIMessage(message)"></i>
          </div>
        </div>
        
        <!-- Message Bubble -->
        <div class="message-bubble" 
             [class.bubble-sent]="isUserMessage(message)"
             [class.bubble-received]="chatMode === 'accountant' && message.senderType === 'ACCOUNTANT'"
             [class.bubble-ai]="chatMode === 'ai' || isAIMessage(message)">
          
          <!-- Sender name for received messages -->
          <div class="message-sender" *ngIf="!isUserMessage(message)">
            <span *ngIf="chatMode === 'accountant'">{{message.senderName}}</span>
            <span *ngIf="chatMode === 'ai' || isAIMessage(message)">AI Tax Assistant</span>
          </div>
          
          <div class="message-text" [innerHTML]="formatMessageContent(message)"></div>
          <div class="message-time">{{message?.timestamp ? formatTime(message.timestamp) : 'Now'}}</div>
        </div>
        
        <!-- Message options for received messages -->
        <div class="message-options" *ngIf="!isUserMessage(message)">
          <button class="btn btn-sm btn-light">
            <i class="ri-more-2-fill"></i>
          </button>
        </div>
        
        <!-- Avatar for sent messages (User) -->
        <div *ngIf="isUserMessage(message)" class="message-avatar">
          <div class="avatar-circle bg-secondary">
            <i class="ri-user-line text-white"></i>
          </div>
        </div>
        </div>
      </div>
    </div>
    
    <!-- Loading indicator -->
    <div *ngIf="isLoading" class="loading-container">
      <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <small class="text-muted ms-2">Loading messages...</small>
    </div>
  </div>

  <!-- Message Input -->
  <div class="p-3 chat-input-section">
    <div class="row">
      <div class="col">
        <div class="position-relative">
          <input type="text" 
                 class="form-control chat-input" 
                 placeholder="Enter Message..." 
                 [(ngModel)]="newMessage" 
                 (keypress)="onKeyPress($event)"
                 [disabled]="isLoading"
                 name="message">
          <div class="chat-input-links">
            <ul class="list-inline mb-0">
              <li class="list-inline-item">
                <a href="javascript: void(0);" class="emoji-btn">
                  <i class="mdi mdi-emoticon-happy-outline"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="javascript: void(0);">
                  <i class="mdi mdi-file-image-outline"></i>
                </a>
              </li>
              <li class="list-inline-item">
                <a href="javascript: void(0);">
                  <i class="mdi mdi-file-document-outline"></i>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-auto">
        <button type="button" 
                class="btn btn-primary btn-rounded chat-send w-md" 
                (click)="sendMessage()" 
                [disabled]="!newMessage.trim() || isLoading">
          <span class="d-none d-sm-inline-block me-2" *ngIf="!isLoading">Send</span>
          <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
          <i class="mdi mdi-send"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI Conversations Sidebar -->
<div class="ai-conversations-sidebar" [class.show]="showConversationsList && chatMode === 'ai'">
  <div class="conversations-header">
    <h6 class="mb-0">AI Conversations</h6>
    <button class="btn btn-sm btn-light" (click)="hideConversations()">
      <i class="ri-close-line"></i>
    </button>
  </div>
  <div class="conversations-list">
    <div *ngFor="let conversation of aiConversations" 
         class="conversation-item" 
         [class.active]="currentAIConversation?.id === conversation.id"
         (click)="selectAIConversation(conversation)">
      <div class="conversation-title">{{conversation.title}}</div>
      <div class="conversation-meta">
        <small class="text-muted">{{formatDate(conversation.updatedAt)}} â€¢ {{conversation.messageCount}} messages</small>
      </div>
    </div>
    <div *ngIf="aiConversations.length === 0" class="no-conversations">
      <i class="ri-chat-3-line text-muted"></i>
      <p class="text-muted mb-0">No conversations yet</p>
    </div>
  </div>
</div>

